function tonemappedXYZ = wTonemap(xyz,l,ccmatrix)

[iy,ix,iz] = size(xyz);
mat = zeros(iy,ix,iz);

cx2u = makecform('xyz2upvpl');
cu2x = makecform('upvpl2xyz');
maxUpvpl = applycform(rgb2XYZ([1 1 1]',ccmatrix),cx2u);
maxLum = maxUpvpl(3);
upvpl = applycform(xyz,cx2u);
mat = upvpl;
disp(maxLum);

Reinhard
for i = 1:iy
    for j = 1:ix
        x = upvpl(i,j,3)/maxlum;
        mat(i,j,3) = maxlum * x/(1+x)*(1+x/l^2);
        if mat(i,j,3) > maxlum
            mat(i,j,3) = maxlum;
        elseif mat(i,j,3) < 0
            mat(i,j,3) = 0;
        end
    end
end

tonemappedXYZ = applycform(mat,cu2x);

end
